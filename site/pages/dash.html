<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Dashboard | WaterWorks</title>

    <link rel="stylesheet" href="../css/estiloNovaDash.css" />

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Rubik:ital,wght@0,300..900;1,300..900&display=swap"
      rel="stylesheet"
    />
    <style>
      @import url("https://fonts.googleapis.com/css2?family=Rubik:ital,wght@0,300..900;1,300..900&display=swap");
    </style>

    <script src="../js/sessao.js"></script>
  </head>
  <body onload="validarSessao(), listar()">
    <header id="headerSuperior">
      <h2>WaterWorks</h2>
      <div>
        <b id="b_empresa">Empresa</b>
      </div>
    </header>

    <main id="main">
      <header id="headerLateral">
        <div id="nomeUsuario">
          Seja bem-vindo, <b id="b_usuario">Usuário</b>
        </div>
        <button>Logout</button>
      </header>

      <section id="graficos">
        <menu>
          <!-- <button onclick="plotar(), plotar2()">Iniciar</button> -->
          <select id="listaPlant" onchange="chamar()">
            <option value="#" selected disabled>Selecione uma plantação</option>
            <option  value="1">Plantação 1</option>
            <option  value="2">Plantação 2</option>
          </select>
          <button onclick=" selecionarPlant(), plotar(), plotar2()">
            Selecionar
          </button>
        </menu>

        <section id="plantacao1" style="display: none">
          <div id="graficoMensalPlant1">
            <div class="kpiNaoEstatica">
              <div class="kpi">
                Média dos Últimos Meses: <br />
                67%
              </div>
              <div class="kpi">
                Status: <br />
                IDEAL
              </div>
            </div>
            <div class="grafico">
              <div class="kpiEstatica">
                <div class="kpi">
                  Umidade Máxima: <br />
                  80%
                </div>
                <div class="kpi">
                  Umidade Mínima: <br />
                  60%
                </div>
              </div>
              <canvas id="myChart"></canvas>
            </div>
          </div>
          <div id="graficoDiarioPlant1" style="display: none">
            <div class="kpiNaoEstatica">
              <div class="kpi">
                Média dos Últimos Meses: <br />
                67%
              </div>
              <div class="kpi">
                Status: <br />
                IDEAL
              </div>
            </div>
            <div class="grafico">
              <div class="kpiEstatica">
                <div class="kpi">
                  Umidade Máxima: <br />
                  80%
                </div>
                <div class="kpi">
                  Umidade Mínima: <br />
                  60%
                </div>
              </div>
              <canvas id="myChart2"></canvas>
            </div>
          </div>

          <div>
            <button onclick="graficoDiario() " class="btnMudarGrafico">
              Gráfico Atual
            </button>
            <button onclick="graficoMensal()" class="btnMudarGrafico">
              Gráfico Mensal
            </button>
          </div>
        </section>

        <section id="plantacao2" style="display: none">
          <div id="graficoMensalPlant2">
            <div class="kpiNaoEstatica">
              <div class="kpi">
                Média dos Últimos Meses: <br />
                59%
              </div>
              <div class="kpi">
                Status: <br />
                IDEAL
              </div>
            </div>
            <div class="grafico">
              <div class="kpiEstatica">
                <div class="kpi">
                  Umidade Máxima: <br />
                  80%
                </div>
                <div class="kpi">
                  Umidade Mínima: <br />
                  60%
                </div>
              </div>
              <canvas id="myChart3" ></canvas>
            </div>
          </div>
          <div id="graficoDiarioPlant2" style="display: none">
            <div class="kpiNaoEstatica">
              <div class="kpi">
                Média dos Últimos Meses: <br />
                66%
              </div>
              <div class="kpi">
                Status: <br />
                IDEAL
              </div>
            </div>
            <div class="grafico">
              <div class="kpiEstatica">
                <div class="kpi">
                  Umidade Máxima: <br />
                  80%
                </div>
                <div class="kpi">
                  Umidade Mínima: <br />
                  60%
                </div>
              </div>
              <canvas id="myChart4"></canvas>
            </div>
          </div>

          <div>
            <button onclick="graficoDiario2()" class="btnMudarGrafico">
              Gráfico Atual
            </button>
            <button onclick="graficoMensal2()" class="btnMudarGrafico">
              Gráfico Mensal
            </button>
          </div>
        </section>
      </section>
      <div id="div_alerta"></div>
    </main>
  </body>
</html>
<script>

  let listaEmpresasCadastradas = [];
  let proximaAtualizacao;
  let proximaAtualizacao2;
  var mes = [];
  var valor_mes = [];
  var mes2 = [];
  var valor_mes2 = [];
  var umidade = [];
  var dtHora = [];
  var umidade2 = [];
  var dtHora2 = [];


  function listar() {
    fetch("/empresas/listar", {
      method: "GET",
    })
      .then(function (resposta) {
        resposta.json().then((empresas) => {
          empresas.forEach((empresa) => {
            listaEmpresasCadastradas.push(empresa);

            console.log("listaEmpresasCadastradas");
            console.log(listaEmpresasCadastradas[0].codigo_ativacao);
          });
        });
      })
      .catch(function (resposta) {
        console.log(`#ERRO: ${resposta}`);
      });
  }

  // Funções de seleção front end

  function destroier_of_alerts() {
    // div_alerta.classList.add("aparecer");
    div_alerta.style.display = "none";
  }

  function alertar_umi() {
    var umidade = "Umidade Alta";
    // var idEmpresaVincular

    for (let i = 0; i < listaEmpresasCadastradas.length; i++) {
      idEmpresaVincular = listaEmpresasCadastradas[i].idEmpresa;
    }

    div_alerta.style.display = "flex";
    // div_alerta.classList.remove("aparecer");
    // div_alerta.querySelector(".p_sit").textContent = "Umidade alta!";
    div_alerta.innerHTML = `
        <img
          src="../imagens/alerta.png"
          style="height: 30px; width: 30px"
          alt=""
        />
        <p id="p_sit">Umidade Alta</p>
        <button id="btn_alerta" onclick="destroier_of_alerts()">OK</button>`;

    fetch("/usuarios/alertar_umi", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
      },
      body: JSON.stringify({
        umiServer: umidade,
        idEmpresaVincularServer: idEmpresaVincular,
      }),
    })
      .then(function (resposta) {
        console.log("resposta: ", resposta);
      })
      .catch(function (erro) {
        console.error("Erro ao enviar dados:", erro);
        alert("erro alerta umi");
      });
  }
  function alertar_desumi() {
    var umidade = "Umidade Baixa";
    // var idEmpresaVincular

    for (let i = 0; i < listaEmpresasCadastradas.length; i++) {
      idEmpresaVincular = listaEmpresasCadastradas[i].idEmpresa;
    }

    div_alerta.style.display = "flex";
    // div_alerta.classList.remove("aparecer");
    // div_alerta.querySelector(".p_sit").textContent = "Umidade alta!";
    div_alerta.innerHTML = `
        <img
          src="../imagens/alerta.png"
          style="height: 30px; width: 30px"
          alt=""
        />
        <p id="p_sit">Umidade Baixa</p>
        <button id="btn_alerta" onclick="destroier_of_alerts()">OK</button>`;

    fetch("/usuarios/alertar_desumi", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
      },
      body: JSON.stringify({
        umiServer: umidade,
        idEmpresaVincularServer: idEmpresaVincular,
      }),
    })
      .then(function (resposta) {
        console.log("resposta: ", resposta);
      })
      .catch(function (erro) {
        console.error("Erro ao enviar dados:", erro);
        alert("Erro desumi");
      });
  }

  function selecionarPlant() {
    var lista = listaPlant.value;

    if (lista == 1) {
      document.getElementById("plantacao1").style.display = "flex";
      document.getElementById("plantacao2").style.display = "none";
    } else if (lista == 2) {
      document.getElementById("plantacao1").style.display = "none";
      document.getElementById("plantacao2").style.display = "flex";
    }

  }

  function plantacao1() {
    document.getElementById("selecionarPlantacao").style.display = "none";
    document.getElementById("plantacao2").style.display = "none";
    document.getElementById("plantacao1").style.display = "flex";
  }

  function plantacao2() {
    document.getElementById("selecionarPlantacao").style.display = "none";
    document.getElementById("plantacao2").style.display = "flex";
    document.getElementById("plantacao1").style.display = "none";
  }

  function graficoMensal() {
    document.getElementById("graficoMensalPlant1").style.display = "none";
    document.getElementById("graficoDiarioPlant1").style.display = "flex";
  }

  function graficoDiario() {
    document.getElementById("graficoMensalPlant1").style.display = "flex";
    document.getElementById("graficoDiarioPlant1").style.display = "none";
  }

  function graficoMensal2() {
    document.getElementById("graficoMensalPlant2").style.display = "none";
    document.getElementById("graficoDiarioPlant2").style.display = "flex";
  }

  function graficoDiario2() {
    document.getElementById("graficoMensalPlant2").style.display = "flex";
    document.getElementById("graficoDiarioPlant2").style.display = "none";
  }


  var ctx = new Chart(document.getElementById("myChart"), {
    type: "line",
    data: {
      labels: dtHora,
      datasets: [
        {
          label: "#Atual",
          data: umidade,
          borderWidth: 1,
        },
      ],
    },
    options: {
      scales: {
        y: {
          beginAtZero: true,
        },
      },
    },
  });

  var ctx2 = new Chart(document.getElementById("myChart2"), {
    type: "bar",
    data: {
      labels: mes,
      datasets: [
        {
          label: "#Mensal",
          data: valor_mes,
          borderWidth: 1,
        },
      ],
    },
    options: {
      scales: {
        y: {
          beginAtZero: true,
        },
      },
    },
  });

  var ctx3 = new Chart(document.getElementById("myChart3"), {
    type: "line",
    data: {
      labels: dtHora2,
      datasets: [
        {
          label: "#Atual",
          data: umidade2,
          borderWidth: 1,
        },
      ],
    },
    options: {
      scales: {
        y: {
          beginAtZero: true,
        },
      },
    },
  });

  var ctx4 = new Chart(document.getElementById("myChart4"), {
    type: "bar",
    data: {
      labels: mes2,
      datasets: [
        {
          label: "#Atual",
          data: valor_mes2,
          borderWidth: 1,
        },
      ],
    },
    options: {
      scales: {
        y: {
          beginAtZero: true,
        },
      },
    },
  });


  function chamar() {
    const valorSelecionado = listaPlant.value;
    if (valorSelecionado == 1) {
      atlGrafico();
    } else if (valorSelecionado == '#') {
      ''
    } else {
      atlGrafico2();
      plotar4();
    }
  }


  function plotar() {
    var idPLANTACAO = Number(listaPlant.value);

    fetch("/usuarios/plotar", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
      },
      body: JSON.stringify({
        idPLANTACAO: idPLANTACAO,
      }),
    })
      .then(function (resposta) {
        console.log("resposta: ", resposta);

        if (resposta.ok) {
        }
      })
      .catch(function (resposta) {
        console.log(`#ERRO: ${resposta}`);
        finalizarAguardar();
      });

    fetch(`/usuarios/plotar`, {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
      },
      body: JSON.stringify({
        idPLANTACAO: idPLANTACAO,
      }),
    })
      .then((resposta) => {
        resposta
          .json()
          .then((dados) => {
            "";
            umidade = [];
            dtHora = [];
            for (var i = 0; i < dados.length; i++) {
              console.log(dados[i].dadoSensor, dados[i].dtRegistro);
              umidade.push(dados[i].dadoSensor);
              dtHora.push(dados[i].dtRegistro);
            }
            var ultima_posicao = umidade[0];
            if (ultima_posicao > 80) {
              alertar_umi();
            } else if (ultima_posicao < 60) {
              alertar_desumi();
            }
            var umidadeReversa = umidade.reverse();
            var dtHoraReversa = dtHora.reverse();

            
              ctx.data.datasets[0].data = umidadeReversa;
              ctx.data.labels = dtHoraReversa;
              ctx.update();
          })
          .catch((erro) => {
            console.log(erro);
          });
      })
      .catch((erro) => {
        console.log(erro);
      });
    }

    function plotar7() {
    var idPLANTACAO = Number(listaPlant.value);

    fetch("/usuarios/plotar7", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
      },
      body: JSON.stringify({
        idPLANTACAO: idPLANTACAO,
      }),
    })
      .then(function (resposta) {
        console.log("resposta: ", resposta);

        if (resposta.ok) {
        }
      })
      .catch(function (resposta) {
        console.log(`#ERRO: ${resposta}`);
        finalizarAguardar();
      });

    fetch(`/usuarios/plotar7`, {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
      },
      body: JSON.stringify({
        idPLANTACAO: idPLANTACAO,
      }),
    })
      .then((resposta) => {
        resposta
          .json()
          .then((dados) => {
            "";
            umidade2 = [];
            dtHora2 = [];
            for (var i = 0; i < dados.length; i++) {
              console.log(dados[i].dadoSensor, dados[i].dtRegistro);
              umidade2.push(dados[i].dadoSensor);
              dtHora2.push(dados[i].dtRegistro);
            }
            var ultima_posicao = umidade2[0];
            if (ultima_posicao > 80) {
              alertar_umi();
            } else if (ultima_posicao < 60) {
              alertar_desumi();
            }
            var umidadeReversa2 = umidade2.reverse();
            var dtHoraReversa2 = dtHora2.reverse();

            
              ctx3.data.datasets[0].data = umidadeReversa2;
              ctx3.data.labels = dtHoraReversa2;
              ctx3.update();
          })
          .catch((erro) => {
            console.log(erro);
          });
      })
      .catch((erro) => {
        console.log(erro);
      });
    }

    
    


    function plotar2() {
    
    fetch("/usuarios/plotar2", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
      },
      body: JSON.stringify({
      }),
    })
      .then(function (resposta) {
        console.log("resposta: ", resposta);

        if (resposta.ok) {
        }
      })
      .catch(function (resposta) {
        console.log(`#ERRO: ${resposta}`);
        finalizarAguardar();
      });

    fetch(`/usuarios/plotar2`, {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
      },
      body: JSON.stringify({
      }),
    })
      .then((resposta) => {
        resposta
          .json()
          .then((dados) => {
            "";
            valor_mes = [];
            mes = [];
            for (var i = 0; i < dados.length; i++) {
              console.log(dados[i].dadoSensor, dados[i].dtRegistro);
              valor_mes.push(dados[i].media_valor);
              mes.push(dados[i].Mes);
            }
            var ultima_posicao = umidade[0];
            
            var umidadeReversa = valor_mes;
            var dtHoraReversa = mes;

           
            ctx2.data.datasets[0].data = umidadeReversa;
            ctx2.data.labels = dtHoraReversa;
            ctx2.update();
          })
          .catch((erro) => {
            console.log(erro);
          });
      })
      .catch((erro) => {
        console.log(erro);
      });

  }

  function plotar4() {
    
    fetch("/usuarios/plotar4", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
      },
      body: JSON.stringify({
      }),
    })
      .then(function (resposta) {
        console.log("resposta: ", resposta);

        if (resposta.ok) {
        }
      })
      .catch(function (resposta) {
        console.log(`#ERRO: ${resposta}`);
        finalizarAguardar();
      });

    fetch(`/usuarios/plotar4`, {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
      },
      body: JSON.stringify({
      }),
    })
      .then((resposta) => {
        resposta
          .json()
          .then((dados) => {
            "";
            valor_mes2 = [];
            mes2 = [];
            for (var i = 0; i < dados.length; i++) {
              console.log(dados[i].dadoSensor, dados[i].dtRegistro);
              valor_mes2.push(dados[i].media_valor);
              mes2.push(dados[i].Mes);
            }
            
            var umidadeReversa2 = valor_mes2;
            var dtHoraReversa2 = mes2;

           
            ctx4.data.datasets[0].data = umidadeReversa2;
            ctx4.data.labels = dtHoraReversa2;
            ctx4.update();
          })
          .catch((erro) => {
            console.log(erro);
          });
      })
      .catch((erro) => {
        console.log(erro);
      });

  }

  function atlGrafico2() {
    proximaAtualizacao2 = setInterval(() => plotar7(), 3000);
    proximaAtualizacao = '';

  }

  function atlGrafico() {
    proximaAtualizacao = setInterval(() => plotar(), 3000);
    proximaAtualizacao2 = ''
  }

</script>
